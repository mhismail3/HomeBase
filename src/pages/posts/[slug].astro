---
import Base from '../../layouts/Base.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { post } = Astro.props;
const { title, date } = post.data;
const base: string = import.meta.env.BASE_URL || '/';
const { Content } = await post.render();
---
<Base title={`${title} â€” Home Base`}>
  <article data-base={base}>
    <header>
      <h1>{title}</h1>
      <p><time datetime={date.toISOString()}>{date.toISOString().slice(0,10)}</time></p>
    </header>
    <Content />
  </article>
  <script is:inline>
    const el = document.querySelector('article[data-base]');
    const base = el ? el.getAttribute('data-base') || '/' : '/';
    // Prefix leading-slash image src/hrefs with base for GitHub Pages subpaths
    for (const el of document.querySelectorAll('article img[src^="/"], article a[href^="/"]')) {
      const attr = el.tagName === 'A' ? 'href' : 'src';
      const v = el.getAttribute(attr);
      if (!v) continue;
      el.setAttribute(attr, base + v.replace(/^\//, ''));
    }
  </script>
</Base>
